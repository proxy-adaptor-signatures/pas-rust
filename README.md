# Proxy Adaptor Signatures
This work is a fork of [traffictse/tss-schnorr-sparkle](https://github.com/traffictse/tss-schnorr-sparkle), extending it to support the proxy adaptor signature primitive.

## Build

```sh
make release
```

## Quick Start (Benchmarks)

Run benchmarks from the built/ folder.
```sh
cd built
```

Run the benchmark script with your desired threshold/party sizes.
```sh
bash run_bench.sh <t>,<n>
# Examples:
#   bash run_bench.sh 2,3
#   bash run_bench.sh 2,3 3,5          # multiple configs
# Optional flags: -i <iters> -s <server> -m <message_hex>
#   e.g. bash run_bench.sh -i 64 -s http://127.0.0.1:8000 2,3
```

Outputs are written to `built/benchmarks/*.csv`.

## CLI Overview

Run the `sparkle_test` binary from the `built/` directory.

### Launch Manager

The MPC manager must be running in a separate terminal for ad-hoc CLI commands.

```sh
cd built
./luban_manager
```

### Commands

*   `rgen`: Generate a random statement/witness pair.
*   `keygen`: Generate a keystore for a single party.
*   `psign`: Participate in generating a pre-signature.
*   `adapt`: Adapt a pre-signature using a witness to create a full signature.
*   `extract`: Extract the witness from a pre-signature and a full signature.
*   `sign`: Participate in generating a standard Schnorr signature.
*   `demo`: Orchestrate the full adaptor-signature exchange on Bitcoin testnet, including funding and payout.
*   `show-addr`: Print funding addresses for the taproot script involving proxies and seller.


## End-to-End Demo (Bitcoin testnet4)

This is the most direct path to see proxy adaptor signatures spend on testnet. You will fund a derived Taproot address and then run the demo to spend that UTXO to the seller address.

1) Generate or prepare keys

```sh
./sparkle_test keygen --party-id 1
./sparkle_test keygen --party-id 2
./sparkle_test keygen --party-id 3
# Optional once: seller Paillier key
./sparkle_test keygen --paillier
```

2) Print addresses to fund and to receive

```sh
./sparkle_test show-addr --party-id 1
# Taproot funding address: tb1p...
# Seller receive address:   tb1q...
```

3) Fund the Taproot address externally (testnet4 faucet)

Wait for confirmation and from a block explorer obtain:

- `--funding-txhash` (txid of your funding tx)
- `--funding-blockhash` (block hash that includes that tx)
- `--funding-vout` (the output index that pays to the printed Taproot address)

4) Run the demo

```sh
./sparkle_test demo \
  --rpc-url https://bitcoin-testnet-rpc.publicnode.com \
  --signers 1,2 \
  --confirmations 1 \
  --funding-txhash <TXID> \
  --funding-blockhash <BLOCK_HASH> \
  --funding-vout <VOUT_INDEX> \
  --broadcast
```

Notes:

- Add `--rpc-user/--rpc-pass` if your endpoint requires authentication.
- Omit `--broadcast` to inspect the fully signed transaction without submitting.
- The demo validates that your `vout` pays to the derived Taproot address; it spends all minus a small fee to the seller’s address and reveals the witness as designed by adaptor signatures.
- The seller’s Paillier key is read from `paillier_keystore.json` (create once with `./sparkle_test keygen --paillier`).

## Other CLI examples

Generate a random statement+witness pair (useful for lower-level flows):

```sh
./sparkle_test rgen
# Witness: bytes_hex:...
# Statement: point_hex:...
```

Pre-sign and adapt/extract (protocol-level):

```sh
./sparkle_test psign   --party-id 1 --message <HEX> --statement <HEX>
./sparkle_test psign   --party-id 2 --message <HEX> --statement <HEX>
./sparkle_test adapt   --witness <HEX>
./sparkle_test extract
```

The extracted value should match the witness generated by `rgen`.
